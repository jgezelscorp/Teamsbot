# Teams Meeting Assistant with Copilot Studio Integration - Implementation Plan

## 1. Architecture Diagram

```mermaid
graph TD
    subgraph "Microsoft Teams Environment"
        Meeting[Teams Meeting]
        Host[Meeting Host (User)]
    end

    subgraph "Azure Environment"
        subgraph "Compute & Connectivity"
            BotService[Azure Bot Service]
            MediaBot["Real-time Media Bot\n(Azure Container Apps)"]
        end
        
        subgraph "AI Services"
            Speech[Azure Speech Service\n(STT)]
            OpenAI[Azure OpenAI\n(Intent Detection)]
        end
    end

    subgraph "External/SaaS"
        Copilot[Microsoft Copilot Studio Agent]
    end

    %% Audio Flow
    Meeting -- "Real-time Audio Stream (RTP)" --> MediaBot
    MediaBot -- "Audio Stream" --> Speech
    Speech -- "Transcript (Text)" --> MediaBot

    %% Intelligence Flow
    MediaBot -- "Transcript Text" --> OpenAI
    OpenAI -- "Intent & Slot Extraction" --> MediaBot

    %% Query Flow
    MediaBot -- "Direct Line API (Query)" --> Copilot
    Copilot -- "Response" --> MediaBot

    %% Response Flow
    MediaBot -- "Private Message" --> BotService
    BotService -- "Delivery" --> Host
```

## 2. Technical Solution & Technologies

### Architecture Choice: Real-time Media Bot
To satisfy the requirement for **Real-time Context** and constant listening, a simple text-based bot is insufficient. We must utilize the **Microsoft Graph Communications API** (Real-time Media Platform).
*   **Why:** Standard bot APIs do not provide a real-time transcript stream. We must ingest the raw audio stream and transcribe it ourselves to achieve low-latency intent detection.

### Technology Stack
*   **Language & SDK**: **C# / .NET 8** using `Microsoft.Graph.Communications.Calls.Media` SDK. (The Media SDK is most robust in .NET).
*   **Hosting**: **Azure Container Apps** (Dedicated Plan).
    *   *Constraint Reason:* Real-time media bots require stateful connections and specific port ranges (TCP/UDP) open for media streaming. Serverless (Functions Consumption) is NOT supported for media bots. Container Apps provides the necessary scale and networking capabilities.
*   **Speech-to-Text**: **Azure AI Speech** (Continuous Recognition).
*   **Intent Detection**: **Azure OpenAI** (GPT-4o or GPT-3.5-Turbo).
    *   *Role:* Analyze the running transcript window to detect if the user is asking a relevant question.
*   **Knowledge Base**: **Microsoft Copilot Studio**.
    *   *Integration:* **Direct Line API**.

## 3. Microsoft Copilot Studio Integration

To bridge the custom bot with your existing Copilot Studio agent, we will use the **Direct Line** channel.

**Required Connection Parameters:**
1.  **Direct Line Secret**:
    *   *How to get:* In Copilot Studio -> Settings -> Channels -> Direct Line -> Add -> Copy "Secret Keys".
2.  **Bot Application ID** (Optional/Implicit):
    *   Used for authenticating distinct users if you need user-specific contexts, otherwise the Secret is sufficient for the bot to act as a proxy.
3.  **Conversation ID**:
    *   Generated by your bot to maintain a thread with the Copilot agent.

**Payload Structure:**
The Media Bot will send a simple HTTP POST to the Direct Line endpoint:
```json
POST https://directline.botframework.com/v3/directline/conversations/{conversationId}/activities
Authorization: Bearer {DIRECT_LINE_SECRET}
{
    "type": "message",
    "from": { "id": "meeting-bot" },
    "text": "The detected question from the meeting..."
}
```

## 4. Permissions (Microsoft Graph)

The Application Registration (Client ID) for the bot in Entra ID requires the following **Application Permissions** (Admin Consent Required):

| Permission | Justification |
| :--- | :--- |
| `Calls.JoinGroupCall.AsGuest` | Allows the bot to join the specific meeting via a join link or invitation. |
| `Calls.AccessMedia.All` | **CRITICAL**. Grants access to the real-time audio/video streams of the call. |
| `OnlineMeetings.ReadWrite.All` | Allows the bot to read meeting details or participant lists if needed. |
| `User.Read.All` | To resolve the "Host" specific user ID for sending private messages. |

## 5. Step-by-Step Implementation Plan

### Phase 1: Infrastructure Setup
1.  **Entra ID App Registration**:
    *   Register a new App.
    *   Create Client Secret.
    *   Add API Permissions (`Calls.AccessMedia.All`, etc.) and grant Admin Consent.
2.  **Azure Resources**:
    *   Create **Azure Bot Service** resource (Multi-tenant) and link to App ID.
    *   Create **Azure AI Speech** resource.
    *   Create **Azure OpenAI** resource and deploy a fast model (e.g., `gpt-35-turbo`).
    *   Create **Azure Container Registry (ACR)** for storing bot images.
    *   Create **Azure Container Apps Environment**.

### Phase 2: Core Media Bot Development
1.  **Scaffold Project**: Create a new C# Console or Worker Service project.
2.  **Install SDKs**:
    *   `Microsoft.Graph.Communications.Calls.Media`
    *   `Microsoft.CognitiveServices.Speech`
3.  **Implement Signaling**: Handle `ICall` state changes (Connecting, Connected, Terminated).
4.  **Implement Media Stream**:
    *   Create an `IAudioSocket`.
    *   Receive mixed audio buffers from the meeting.
5.  **Transcription Integration**:
    *   Pipe audio buffers from `IAudioSocket` into `PushAudioInputStream` for Azure Speech SDK.
    *   Handle `Recognized` events to get text.

### Phase 3: Intelligence Layer
1.  **Buffering**: Maintain a rolling window of the last 30-60 seconds of transcript.
2.  **Intent Loop**:
    *   Every few seconds (or on sentence pause), send the buffer to Azure OpenAI.
    *   *Prompt:* "Analyze this conversation snippet. Did someone ask a question about [TOPIC]? If yes, extract the question."
3.  **Copilot Bridge**:
    *   If a question is extracted, call `CopilotClient.AskAsync(question)`.
    *   Receive the text answer.

### Phase 4: Feedback Loop (Work Private Response)
1.  **Resolve Host**: Identify the user ID of the meeting organizer or the specific user you want to notify.
2.  **Send Notification**:
    *   Use the standard Bot Framework Adapter (shimmed alongside the Media SDK) to send a proactive message to that user ID.
    *   *Note:* You may need to "install" the bot for that user personally (Personal Scope) to allow private messaging.

### Phase 5: Deployment
1.  **Dockerize**: Create a `Dockerfile` exposing the necessary media ports (usually variable) and HTTP port.
2.  **Network Configuration**:
    *   Configure Azure Container Apps to allow Ingress.
    *   **Public IP**: Media bots need a publicly accessible endpoint for the media control plane.
3.  **Deploy**: Push image to ACR and deploy to Container Apps.
4.  **Test**: Schedule a Teams meeting, invite the bot logic (via Join URL or adding via ID), and verify it joins and listens.

